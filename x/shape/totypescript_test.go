package shape

import (
	"github.com/stretchr/testify/assert"
	"os"
	"testing"
)

func TestTypeScriptSchemaGeneration(t *testing.T) {

	tsr := NewTypeScriptRenderer()
	tsr.AddUnion(&UnionLike{
		Name:          "Tree",
		PkgName:       "test",
		PkgImportName: "test",
		Variant: []Shape{
			&StructLike{
				Name:          "Branch",
				PkgName:       "test",
				PkgImportName: "go.import.test",
				Fields: []*FieldLike{
					{
						Name: "L",
						Type: &RefName{
							Name:          "Tree",
							PkgName:       "test",
							PkgImportName: "go.import.test",
						},
					},
					{
						Name: "R",
						Type: &RefName{
							Name:          "Tree",
							PkgName:       "test",
							PkgImportName: "go.import.test",
						},
					},
				},
			},
			&StructLike{
				Name:          "Leaf",
				PkgName:       "test",
				PkgImportName: "go.import.test",
				Fields: []*FieldLike{
					{
						Name: "Value",
						Type: &RefName{
							Name:          "Schema",
							PkgName:       "schema",
							PkgImportName: "github.com/widmogrod/mkunion/x/schema",
						},
					},
				},
			},
		},
	})

	tsr.AddStruct(&StructLike{
		Name:          "SomeStruct",
		PkgName:       "test",
		PkgImportName: "go.import.test",
		Fields:        nil,
	})

	err := tsr.WriteToDir("_test/")
	assert.NoError(t, err)

	assert.FileExists(t, "_test/test.ts")

	contents, err := os.ReadFile("_test/test.ts")
	assert.NoError(t, err)

	expected := `//generated by mkunion

/**
* This function is used to remove $type field from Tree, so it can be understood by mkunion, 
* that is assuming unions have one field in object, that is used to discriminate between variants.
*/
export function dediscriminateTree(x: Tree): Tree {
    if (x["$type"] !== undefined) {
        delete x["$type"]
        return x
    }
    return x
}

/**
* This function is used to populate $type field in Tree, so it can be used as discriminative switch statement
* @example https://www.typescriptlang.org/play#example/discriminate-types
*/
export function discriminateTree(x: Tree): Tree {
    if (x["$type"] === undefined) {
        let keyx = Object.keys(x)
        if (keyx.length === 1) {
            x["$type"] = keyx[0] as any
        }
    }
    return x
}

export type Tree = {
	// $type this is optional field, that is used to enable discriminative switch-statement in TypeScript, its not part of mkunion schema
	"$type"?: "test.Branch",
	"test.Branch": Branch
} | {
	// $type this is optional field, that is used to enable discriminative switch-statement in TypeScript, its not part of mkunion schema
	"$type"?: "test.Leaf",
	"test.Leaf": Leaf
}

export type Branch = {
	L?: Tree,
	R?: Tree,
}

export type Leaf = {
	Value?: schema.Schema,
}

export type SomeStruct = {
}

//eslint-disable-next-line
import * as schema from './github_com_widmogrod_mkunion_x_schema'
`
	assert.Equal(t, expected, string(contents))
}
